{% extends 'layout.html' %} 

{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
  <div>
    <h2 style="font-size: 2.5em; margin-bottom: 5px;">ðŸ“Š Trading Dashboard</h2>
    <p style="color: #666; font-size: 1.1em;">Welcome back, <strong>{{ session['username'] }}</strong>!</p>
  </div>
  <div style="display: flex; gap: 15px;">
    <a href="/portfolio" class="btn" style="background: #28a745;">ðŸ“ˆ Portfolio</a>
    <a href="/logout" class="btn" style="background: #dc3545;">ðŸšª Logout</a>
  </div>
</div>

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
  <h3 style="color: white; margin-bottom: 10px;">ðŸ’° Available Balance</h3>
  <p style="font-size: 2em; font-weight: bold; margin: 0;">â‚¹{{ '%.2f'|format(balance) }}</p>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h3>ðŸ“ˆ Live Stock Prices (Top 50 NSE Stocks)</h3>
  <div id="connection-status" style="padding: 5px 10px; border-radius: 15px; font-size: 12px; background: #28a745; color: white;">
    ðŸŸ¢ LIVE
  </div>
</div>

<div style="overflow-x: auto;">
  <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <tr>
        <th style="padding: 15px; text-align: left;">Symbol</th>
        <th style="padding: 15px; text-align: left;">Company</th>
        <th style="padding: 15px; text-align: right;">Live Price (â‚¹)</th>
        <th style="padding: 15px; text-align: center;">Buy</th>
        <th style="padding: 15px; text-align: center;">Sell</th>
      </tr>
    </thead>
    <tbody>
      {% for stock in stocks %}
      <tr style="border-bottom: 1px solid #eee;" data-symbol="{{ stock.symbol }}">
        <td style="padding: 15px; font-weight: bold; color: #333;">{{ stock.symbol }}</td>
        <td style="padding: 15px; color: #666;">{{ stock.name }}</td>
        <td style="padding: 15px; text-align: right; font-weight: bold; color: #28a745;" class="live-price">
          â‚¹{{ '%.2f'|format(stock.price) }}
        </td>
        <td style="padding: 15px; text-align: center;">
          <form method="POST" action="/buy" style="display: inline-flex; align-items: center; gap: 10px;">
            <input type="hidden" name="symbol" value="{{ stock.symbol }}">
            <input type="hidden" name="price" value="{{ stock.price }}" class="current-price">
            <input type="number" name="quantity" value="1" min="1" max="1000" 
                   style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
            <button type="submit" class="btn" style="padding: 8px 15px; font-size: 14px; background: #28a745;">
              ðŸ›’ Buy
            </button>
          </form>
        </td>
        <td style="padding: 15px; text-align: center;">
          <form method="POST" action="/sell" style="display: inline-flex; align-items: center; gap: 10px;">
            <input type="hidden" name="symbol" value="{{ stock.symbol }}">
            <input type="hidden" name="price" value="{{ stock.price }}" class="current-price">
            <input type="number" name="quantity" value="1" min="1" max="1000" 
                   style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
            <button type="submit" class="btn" style="padding: 8px 15px; font-size: 14px; background: #dc3545;">
              ðŸ’° Sell
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
  <p style="color: #666; margin: 0;">
    <strong>Note:</strong> Live prices update in real-time. Trading simulator for educational purposes only.
  </p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    
    socket.on('connect', function() {
        document.getElementById('connection-status').innerHTML = 'ðŸŸ¢ LIVE';
        document.getElementById('connection-status').style.background = '#28a745';
    });
    
    socket.on('disconnect', function() {
        document.getElementById('connection-status').innerHTML = 'ðŸ”´ OFFLINE';
        document.getElementById('connection-status').style.background = '#dc3545';
    });
    
    socket.on('price_update', function(data) {
        const symbol = data.symbol;
        const price = data.price;
        
        // Find the row for this symbol
        const row = document.querySelector(`tr[data-symbol="${symbol}"]`);
        if (row) {
            // Update the live price display
            const priceCell = row.querySelector('.live-price');
            if (priceCell) {
                priceCell.textContent = `â‚¹${price.toFixed(2)}`;
                
                // Add flash effect
                priceCell.style.background = '#fff3cd';
                setTimeout(() => {
                    priceCell.style.background = 'transparent';
                }, 500);
            }
            
            // Update hidden price inputs
            const priceInputs = row.querySelectorAll('.current-price');
            priceInputs.forEach(input => {
                input.value = price;
            });
        }
    });
</script>

{% endblock %}